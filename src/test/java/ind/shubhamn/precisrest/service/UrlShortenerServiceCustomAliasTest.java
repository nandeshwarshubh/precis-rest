package ind.shubhamn.precisrest.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

import ind.shubhamn.precisrest.dao.UrlShortenerDAO;
import ind.shubhamn.precisrest.exception.ShortUrlAlreadyExistsException;
import ind.shubhamn.precisrest.model.ShortenedUrl;
import java.util.Optional;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

public class UrlShortenerServiceCustomAliasTest {

    @InjectMocks private UrlShortenerService urlShortenerService;

    @Mock private UrlShortenerDAO urlShortenerDAO;

    @BeforeEach
    public void setup() {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    public void testShortenUrlWithCustomAlias_Success() throws Exception {
        // Arrange
        String longUrl = "https://www.example.com";
        String customAlias = "my-custom-link";

        when(urlShortenerDAO.findByShortUrl(customAlias)).thenReturn(Optional.empty());
        when(urlShortenerDAO.save(any(ShortenedUrl.class)))
                .thenAnswer(invocation -> invocation.getArgument(0));

        // Act
        String result = urlShortenerService.shortenUrl(longUrl, customAlias);

        // Assert
        assertEquals(customAlias, result);
        verify(urlShortenerDAO, times(1)).findByShortUrl(customAlias);
        verify(urlShortenerDAO, times(1)).save(any(ShortenedUrl.class));
    }

    @Test
    public void testShortenUrlWithCustomAlias_AlreadyExists() {
        // Arrange
        String longUrl = "https://www.example.com";
        String customAlias = "existing-alias";

        ShortenedUrl existingUrl = new ShortenedUrl();
        existingUrl.setShortUrl(customAlias);
        existingUrl.setLongUrl("https://www.other.com");

        when(urlShortenerDAO.findByShortUrl(customAlias)).thenReturn(Optional.of(existingUrl));

        // Act & Assert
        ShortUrlAlreadyExistsException exception =
                assertThrows(
                        ShortUrlAlreadyExistsException.class,
                        () -> urlShortenerService.shortenUrl(longUrl, customAlias));

        assertTrue(exception.getMessage().contains(customAlias));
        assertTrue(exception.getMessage().contains("already in use"));
        verify(urlShortenerDAO, times(1)).findByShortUrl(customAlias);
        verify(urlShortenerDAO, never()).save(any(ShortenedUrl.class));
    }

    @Test
    public void testShortenUrlWithCustomAlias_DifferentUrls() throws Exception {
        // Arrange
        String longUrl1 = "https://www.example1.com";
        String longUrl2 = "https://www.example2.com";
        String customAlias1 = "link1";
        String customAlias2 = "link2";

        when(urlShortenerDAO.findByShortUrl(anyString())).thenReturn(Optional.empty());
        when(urlShortenerDAO.save(any(ShortenedUrl.class)))
                .thenAnswer(invocation -> invocation.getArgument(0));

        // Act
        String result1 = urlShortenerService.shortenUrl(longUrl1, customAlias1);
        String result2 = urlShortenerService.shortenUrl(longUrl2, customAlias2);

        // Assert
        assertEquals(customAlias1, result1);
        assertEquals(customAlias2, result2);
        assertNotEquals(result1, result2);
        verify(urlShortenerDAO, times(2)).save(any(ShortenedUrl.class));
    }

    @Test
    public void testShortenUrl_AutoGenerated_StillWorks() throws Exception {
        // Arrange
        String longUrl = "https://www.google.com";

        when(urlShortenerDAO.save(any(ShortenedUrl.class)))
                .thenAnswer(invocation -> invocation.getArgument(0));

        // Act
        String result = urlShortenerService.shortenUrl(longUrl, null);

        // Assert
        assertNotNull(result);
        assertEquals(8, result.length()); // Auto-generated URLs are 8 characters
        verify(urlShortenerDAO, times(1)).save(any(ShortenedUrl.class));
    }
}
